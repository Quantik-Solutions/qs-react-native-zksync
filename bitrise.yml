---
format_version: '8'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: react-native
workflows:
  android:
    steps:
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone@4: {}
    - cache-pull@2:
        inputs:
        - is_debug_mode: 'true'
    - brew-install@0:
        inputs:
        - cache_enabled: 'yes'
        - verbose_log: 'yes'
        - packages: sccache
    - script@1:
        title: Install Rust & Build Libraries
        inputs:
        - is_debug: 'yes'
        - content: |
            #!/usr/bin/env bash
            # fail if any commands fails
            set -e
            # debug log
            set -x

            bash ./build.sh
            bash ./android_build.sh
    - install-react-native@0: {}
    - npm@1:
        inputs:
        - cache_local_deps: 'true'
        - command: install -g detox-cli
    - yarn@0:
        inputs:
        - verbose_log: 'yes'
        - command: install
    - yarn@0:
        inputs:
        - workdir: example
        - command: install
    - react-native-bundle@1:
        inputs:
        - entry_file: example/index.js
        - platform: android
    - cache-push@2:
        inputs:
        - is_debug_mode: 'true'
        - compress_archive: 'true'
        - cache_paths: |-
            $CARGO_INSTALL_DIR
            $SCCACHE_DIR
        is_always_run: true
    - script@1:
        title: Detox Utils
        inputs:
        - is_debug: 'yes'
        - content: |-
            #!/usr/bin/env bash
            # fail if any commands fails
            set -e
            # debug log
            set -x

            brew tap wix/brew
            brew install applesimutils

            cd $TEST_PROJECT_ROOT
            detox build --configuration android.emu.release.bitrise
            detox test --configuration android.emu.release.bitrise --cleanup
    - deploy-to-bitrise-io@1: {}
  ios:
    steps:
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone@4: {}
    - cache-pull@2:
        inputs:
        - is_debug_mode: 'true'
    - brew-install@0:
        inputs:
        - cache_enabled: 'yes'
        - verbose_log: 'yes'
        - packages: sccache
    - script@1:
        title: Install Rust & Build Libraries
        inputs:
        - is_debug: 'yes'
        - content: |-
            #!/usr/bin/env bash
            # fail if any commands fails
            set -e
            # debug log
            set -x

            bash $PROJECT_ROOT/build.sh
            bash $PROJECT_ROOT/ios_build.sh
    - install-react-native@0: {}
    - npm@1:
        inputs:
        - cache_local_deps: 'true'
        - command: install -g detox-cli
    - yarn@0:
        inputs:
        - verbose_log: 'yes'
        - cache_local_deps: 'yes'
        - command: install
    - yarn@0:
        inputs:
        - workdir: example
        - command: install
    - react-native-bundle@1:
        inputs:
        - entry_file: example/index.js
        - platform: android
    - cache-push@2:
        inputs:
        - is_debug_mode: 'true'
        - compress_archive: 'true'
        - cache_paths: |-
            $CARGO_INSTALL_DIR
            $SCCACHE_DIR
        is_always_run: true
    - script@1:
        title: Detox Utils
        inputs:
        - is_debug: 'yes'
        - content: |-
            #!/usr/bin/env bash
            # fail if any commands fails
            set -e
            # debug log
            set -x

            brew tap wix/brew
            brew install applesimutils

            cd $TEST_PROJECT_ROOT
            detox build --configuration android.emu.debug
            detox test --configuration android.emu.debug --cleanup
    - deploy-to-bitrise-io@1: {}
app:
  envs:
  - opts:
      is_expand: false
    PROJECT_LOCATION: "/Users/vagrant/git/example/android"
  - opts:
      is_expand: false
    MODULE: Example / Base Testing Application
  - opts:
      is_expand: false
    VARIANT: Debug
  - opts:
      is_expand: false
    BITRISE_PROJECT_PATH: example/ios/example.xcodeproj
  - opts:
      is_expand: false
    BITRISE_SCHEME: example
  - opts:
      is_expand: false
    BITRISE_EXPORT_METHOD: development
  - opts:
      is_expand: false
    CARGO_INSTALL_DIR: "/Users/vagrant/.cargo"
  - opts:
      is_expand: false
    NATIVE_MODULE_ANDROID_DIR: "/Users/vagrant/git/android"
  - opts:
      is_expand: false
    SCCACHE_DIR: "/Users/vagrant/sccache_dir"
  - opts:
      is_expand: false
    TEST_PROJECT_ROOT: "/Users/vagrant/git/example"
  - opts:
      is_expand: false
    PROJECT_ROOT: "/Users/vagrant/git"
  - opts:
      is_expand: false
    ZKSYNC_LIB_DIR: "/Users/vagrant/git/zksync/sdk/zksync-java"
  - opts:
      is_expand: false
    DEBUG_APK: "/Users/vagrant/git/example/android/app/build/outputs/apk/debug/app-debug.apk"
trigger_map:
- push_branch: ios
  workflow: ios
